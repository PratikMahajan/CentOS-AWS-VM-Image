{
    "variables": {
        "ssh_username":"centos",
        "AWS_ACCESS_KEY_ID": "",
        "AWS_SECRET_ACCESS_KEY": "",
        "aws_region": "",
        "subnet_id": "",
        "source_ami": "",
        "DB_ROOT_PASSWORD": "",
        "DB_USER": "",
        "DB_PASSWORD": "",
        "DATABASE_NAME": "",
        "DB_HOST": ""
    },
    "builders": [
        {
            "type": "amazon-ebs",
            "access_key": "{{user `AWS_ACCESS_KEY_ID`}}",
            "secret_key": "{{user `AWS_SECRET_ACCESS_KEY`}}",
            "region": "{{user `aws_region`}}",
            "instance_type": "t2.micro",
            "subnet_id": "{{user `subnet_id`}}",
            "source_ami": "{{user `source_ami`}}",
            "ssh_username": "{{user `ssh_username`}}",
            "ami_name": "csye6225_{{timestamp}}",
            "ami_description": "CentOS AMI for RecipeApp",
            "launch_block_device_mappings": [
                {
                    "device_name": "/dev/sda1",
                    "volume_size": 8,
                    "volume_type": "gp2",
                    "delete_on_termination": true
                }
            ],
	    "tags": {
          "Source_AMI": "{{user `source_ami`}}",
          "OS": "CentOS 7",
          "Runner": "EC2",
          "Name": "RecipeWebApp"
          }
        }
    ],
    "provisioners": [
        {
            "type": "shell",
            "environment_vars": [
                "DB_ROOT_PASSWORD={{user `DB_ROOT_PASSWORD`}}",
                "DB_USER={{user `DB_USER`}}",
                "DB_PASSWORD={{user `DB_PASSWORD`}}",
                "DATABASE_NAME={{user `DATABASE_NAME`}}",
                "DB_HOST={{user `DB_HOST`}}"
            ],
	    "inline": [
                "yum check-update",
		"yum install https://centos7.iuscommunity.org/ius-release.rpm",
                "yum install python36u python36u-devel python36u-pip",
		"pip3 install awscli==1.16.254",
                "pip3 install bcrypt==3.1.7",
                "pip3 install botocore==1.12.244",
                "pip3 install cffi==1.12.3",
                "pip3 install Click==7.0",
                "pip3 install colorama==0.4.1",
                "pip3 install docutils==0.15.2",
                "pip3 install Flask==1.1.1",
                "pip3 install Flask-HTTPAuth==3.3.0",
                "pip3 install gunicorn==19.9.0",
                "pip3 install itsdangerous==1.1.0",
                "pip3 install Jinja2==2.10.1",
                "pip3 install jmespath==0.9.4",
                "pip3 install MarkupSafe==1.1.1",
                "pip3 install nose==1.3.7",
                "pip3 install pyasn1==0.4.7",
                "pip3 install pycparser==2.19",
                "pip3 install PyMySQL==0.9.3",
                "pip3 install python-dateutil==2.8.0",
                "pip3 install PyYAML==5.1.2",
                "pip3 install rsa==3.4.2",
                "pip3 install s3transfer==0.2.1",
                "pip3 install six==1.12.0",
                "pip3 install SQLAlchemy==1.3.8",
                "pip3 install urllib3==1.25.6",
                "pip3 install Werkzeug==0.16.0"
	    ],
            "scripts": [
              "scripts/dbsetup.sh",
              "scripts/dbinit.sh"
              ]
        }
    ]
}
